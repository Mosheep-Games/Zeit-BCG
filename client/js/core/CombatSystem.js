
window.CombatSystem={applyDamage(source,target,dmg,type="physical"){if(target.dead)return;const critChance=source.stats.critChance||0;const critMult=source.stats.critMultiplier||1.5;let finalDamage=dmg;if(Math.random()<critChance){finalDamage*=critMult;}if(type==="physical"){const armor=target.stats.armor||0;const reduction=armor/(armor+100);finalDamage*=(1-reduction);}if(type==="magic"){const res=target.stats.resistance||0;finalDamage*=(1-res);}if(target.shield>0){const absorbed=Math.min(target.shield,finalDamage);target.shield-=absorbed;finalDamage-=absorbed;}if(finalDamage<0)finalDamage=0;target.stats.hp-=finalDamage;if(target.stats.hp<=0){target.dead=true;}},applyStatus(target,effect){if(!target.statusEffects)target.statusEffects=[];const resist=target.stats.statusResist||0;if(Math.random()<resist){return;}const eff={...effect,time:0,initialSpeed:target.stats.speed};if(eff.onStart)eff.onStart(target);target.statusEffects.push(eff);},updateStatus(target,dt){if(!target.statusEffects)return;target.statusEffects=target.statusEffects.filter(eff=>{eff.time+=dt;if(eff.interval){eff._acc=(eff._acc||0)+dt;if(eff._acc>=eff.interval){eff._acc=0;if(eff.tick)eff.tick(target);}}if(eff.time>=eff.duration){if(eff.type==="slow")target.stats.speed=eff.initialSpeed;if(eff.onEnd)eff.onEnd(target);return false;}return true;});}};
